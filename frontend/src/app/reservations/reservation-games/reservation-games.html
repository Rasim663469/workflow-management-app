<section class="games-card">
  <header>
    <div>
      <p class="eyebrow">Jeux & placement</p>
      <h2>Placement des jeux</h2>
    </div>
  </header>

  @if (!reservation()) {
    <p class="empty">Sélectionnez une réservation pour gérer les jeux.</p>
  }

  @if (reservation()) {
    @if (!auth.canManagePlacement()) {
      <p class="error">Accès réservé aux organisateurs pour le placement des jeux.</p>
    }
    <div class="alerts">
      @if (wishesAlert()) { <p class="alert">{{ wishesAlert() }}</p> }
      @if (stockAlert()) { <p class="alert">{{ stockAlert() }}</p> }
      @if (capacityAlert()) { <p class="alert">{{ capacityAlert() }}</p> }
      @if (unplacedAlert()) { <p class="alert">{{ unplacedAlert() }}</p> }
    </div>

    @if (reservationBudget(); as budget) {
      <div class="stock-grid">
        <div class="stock-card">
          <p class="label">Standard (souhaité)</p>
          <p class="value">{{ budget.wishes.standard }}</p>
          <p class="sub">Souhait exprimé</p>
        </div>
        <div class="stock-card">
          <p class="label">Grandes (souhaité)</p>
          <p class="value">{{ budget.wishes.grandes }}</p>
          <p class="sub">Souhait exprimé</p>
        </div>
        <div class="stock-card">
          <p class="label">Mairie (souhaité)</p>
          <p class="value">{{ budget.wishes.mairie }}</p>
          <p class="sub">Souhait exprimé</p>
        </div>
        <div class="stock-card">
          <p class="label">Total tables souhaitées</p>
          <p class="value">{{ budget.wishes.total }}</p>
          <p class="sub">Somme des souhaits</p>
        </div>
        <div class="stock-card">
          <p class="label">Espace réservé</p>
          <p class="value">{{ budget.reservedTotal }}</p>
          <p class="sub">Tables réservées</p>
        </div>
        <div class="stock-card">
          <p class="label">Reste sur réservation</p>
          <p class="value">{{ budget.reservedRemaining }}</p>
          <p class="sub">Après placement</p>
        </div>
      </div>
    }

    @if (stockUsage(); as stock) {
      <div class="stock-grid">
        <div class="stock-card">
          <p class="label">Standard (stock)</p>
          <p class="value">{{ stock.used.standard }} / {{ stock.totals.standard }}</p>
          <p class="sub">Restant: {{ stock.remaining.standard }}</p>
        </div>
        <div class="stock-card">
          <p class="label">Grandes (stock)</p>
          <p class="value">{{ stock.used.grandes }} / {{ stock.totals.grandes }}</p>
          <p class="sub">Restant: {{ stock.remaining.grandes }}</p>
        </div>
        <div class="stock-card">
          <p class="label">Mairie (stock)</p>
          <p class="value">{{ stock.used.mairie }} / {{ stock.totals.mairie }}</p>
          <p class="sub">Restant: {{ stock.remaining.mairie }}</p>
        </div>
        <div class="stock-card">
          <p class="label">Chaises (stock)</p>
          <p class="value">{{ stock.used.chaises }} / {{ stock.totals.chaises }}</p>
          <p class="sub">Restant: {{ stock.remaining.chaises }}</p>
        </div>
      </div>
    }

    @if (error()) {
      <p class="error">{{ error() }}</p>
    }

    <form class="create-form" (submit)="handleSubmit($event)">
      <div class="field">
        <label>Jeu</label>
        <select
          [value]="newGame().jeu_id ?? ''"
          (change)="setNewGame('jeu_id', $any($event.target).value ? toNumber($any($event.target).value) : null)"
          [disabled]="!auth.canManagePlacement()"
        >
          <option value="">Choisir un jeu</option>
          @for (jeu of jeux(); track jeu.id) {
            <option [value]="jeu.id">{{ jeu.name }}</option>
          }
        </select>
      </div>
      <div class="field small">
        <label>Quantité</label>
        <input
          type="number"
          min="1"
          [value]="newGame().quantite"
          (input)="setNewGame('quantite', toNumber($any($event.target).value))"
          [disabled]="!auth.canManagePlacement()"
        />
      </div>
      <div class="field small">
        <label>Tables utilisées (total)</label>
        <input
          type="number"
          step="0.5"
          min="0"
          [value]="newGame().tables_utilisees"
          (input)="setNewGame('tables_utilisees', toNumber($any($event.target).value))"
          [disabled]="!auth.canManagePlacement()"
        />
      </div>
      <div class="field">
        <label>Type table</label>
        <select
          [value]="newGame().type_table"
          (change)="setNewGame('type_table', $any($event.target).value)"
          [disabled]="!auth.canManagePlacement()"
        >
          <option value="standard">Standard</option>
          <option value="grande">Grande</option>
          <option value="mairie">Mairie</option>
        </select>
      </div>
      <div class="field">
        <label>Zone plan</label>
        <select
          [value]="newGame().zone_plan_id ?? ''"
          (change)="setNewGame('zone_plan_id', $any($event.target).value ? toNumber($any($event.target).value) : null)"
          [disabled]="!auth.canManagePlacement()"
        >
          <option value="">Non placée</option>
          @for (zone of eligibleZones(); track zone.id) {
            <option [value]="zone.id">
              {{ zone.nom }}
              @if (remainingForZonePlan(zone.id) !== null) {
                (reste {{ remainingForZonePlan(zone.id) }} tables)
              }
            </option>
          }
        </select>
        @if (!newGame().zone_plan_id) {
          <p class="hint">Non placée → pas comptée dans le stock mobilier</p>
        }
      </div>
      <div class="field toggle">
        <label>
          <input
            type="checkbox"
            [checked]="newGame().liste_demandee"
            (change)="setNewGame('liste_demandee', $any($event.target).checked)"
            [disabled]="!auth.canManagePlacement()"
          />
          Liste demandée
        </label>
      </div>
      <div class="field toggle">
        <label>
          <input
            type="checkbox"
            [checked]="newGame().liste_obtenue"
            (change)="setNewGame('liste_obtenue', $any($event.target).checked)"
            [disabled]="!auth.canManagePlacement()"
          />
          Liste obtenue
        </label>
      </div>
      <div class="field toggle">
        <label>
          <input
            type="checkbox"
            [checked]="newGame().jeux_recus"
            (change)="setNewGame('jeux_recus', $any($event.target).checked)"
            [disabled]="!auth.canManagePlacement()"
          />
          Jeux reçus
        </label>
      </div>
      <button type="submit" [disabled]="!auth.canManagePlacement()">Ajouter</button>
    </form>

    <div class="list">
      @for (game of games(); track game.id) {
        <article class="row">
          <div>
            <p class="name">{{ game.nom_jeu }}</p>
            <p class="meta">
              Quantité {{ game.quantite }}
              · Total {{ game.tables_utilisees }} tables
              · {{ perGameTables(game.tables_utilisees, game.quantite) | number : '1.1-2' }} table/jeu
            </p>
            @if (!game.zone_plan_id) {
              <span class="tag warn">Non placé · stock non compté</span>
            }
          </div>
          <div class="field small">
            <label>Quantité</label>
            <input
              type="number"
              min="1"
              [value]="game.quantite"
              (input)="updateDraftField(game.id, 'quantite', toNumber($any($event.target).value))"
              [disabled]="!auth.canManagePlacement()"
            />
          </div>
          <div class="field small">
            <label>Zone</label>
            <select
              [value]="game.zone_plan_id ?? ''"
              (change)="updateDraftField(game.id, 'zone_plan_id', $any($event.target).value ? toNumber($any($event.target).value) : null)"
              [disabled]="!auth.canManagePlacement()"
            >
              <option value="">Non placée</option>
              @for (zone of eligibleZones(); track zone.id) {
                <option [value]="zone.id">{{ zone.nom }}</option>
              }
            </select>
          </div>
          <div class="field small">
            <label>Type</label>
            <select
              [value]="game.type_table"
              (change)="updateDraftField(game.id, 'type_table', $any($event.target).value)"
              [disabled]="!auth.canManagePlacement()"
            >
              <option value="standard">Standard</option>
              <option value="grande">Grande</option>
              <option value="mairie">Mairie</option>
            </select>
          </div>
          <div class="field small">
            <label>Tables (stock)</label>
            <input
              type="number"
              step="0.5"
              min="0"
              [value]="game.tables_utilisees"
              (input)="updateDraftField(game.id, 'tables_utilisees', toNumber($any($event.target).value))"
              [disabled]="!auth.canManagePlacement()"
            />
          </div>
          <div class="field toggle">
            <label>
              <input
                type="checkbox"
                [checked]="game.liste_demandee"
                (change)="updateDraftField(game.id, 'liste_demandee', $any($event.target).checked)"
                [disabled]="!auth.canManagePlacement()"
              />
              Demandée
            </label>
            <label>
              <input
                type="checkbox"
                [checked]="game.liste_obtenue"
                (change)="updateDraftField(game.id, 'liste_obtenue', $any($event.target).checked)"
                [disabled]="!auth.canManagePlacement()"
              />
              Obtenue
            </label>
            <label>
              <input
                type="checkbox"
                [checked]="game.jeux_recus"
                (change)="updateDraftField(game.id, 'jeux_recus', $any($event.target).checked)"
                [disabled]="!auth.canManagePlacement()"
              />
              Reçus
            </label>
          </div>
          <div class="actions">
            <button type="button" class="ghost" (click)="saveDraft(game.id)" [disabled]="!auth.canManagePlacement()">
              Enregistrer
            </button>
            <button type="button" class="ghost" (click)="delete(game.id)" [disabled]="!auth.canManagePlacement()">
              Supprimer
            </button>
          </div>
        </article>
      }
      @if (!loading() && games().length === 0) {
        <p class="empty">Aucun jeu ajouté.</p>
      }
    </div>
  }
</section>
