<section class="page">
  <header class="page-header">
    <div>
      <p class="eyebrow">Réservations</p>
      <h1>Gestion des réservations</h1>
    </div>
    <div class="selector">
      <label for="festival">Festival</label>
      <select id="festival" [value]="selectedFestivalId() ?? ''" (change)="onFestivalChange($event)">
        @for (festival of festivals(); track festival.id) {
          <option [value]="'' + festival.id">{{ festival.name }}</option>
        }
      </select>
    </div>
  </header>

  @if (loadingFestivals()) {
    <p>Chargement des festivals...</p>
  }

  @if (selectedFestivalId()) {
    <div class="tabs">
      @if (auth.canManageReservations()) {
        <button type="button" class="tab" [class.active]="activeTab() === 'suivi'" (click)="activeTab.set('suivi')">
          Suivi CRM
        </button>
      }
      <button type="button" class="tab" [class.active]="activeTab() === 'reservations'" (click)="activeTab.set('reservations')">
        Réservations
      </button>
      @if (auth.canManageReservations()) {
        <button type="button" class="tab" [class.active]="activeTab() === 'nouvelle'" (click)="activeTab.set('nouvelle')">
          Nouvelle réservation
        </button>
      }
      @if (auth.canManagePlacement()) {
        <button type="button" class="tab" [class.active]="activeTab() === 'jeux'" (click)="activeTab.set('jeux')">
          Jeux & placement
        </button>
        <button type="button" class="tab" [class.active]="activeTab() === 'plan'" (click)="activeTab.set('plan')">
          Zones du plan
        </button>
      }
    </div>

    @if (activeTab() === 'suivi') {
      @if (auth.canManageReservations()) {
        <app-crm-list [festivalId]="selectedFestivalId()!" />
      } @else {
        <p class="empty">Accès réservé aux super-organisateurs.</p>
      }
    }

    @if (activeTab() === 'reservations') {
      <app-reservations-list
        [festivalId]="selectedFestivalId()!"
        (editRequested)="handleEditRequested($event)"
        (gamesRequested)="handleGamesRequested($event)"
      />
    }

    @if (activeTab() === 'nouvelle') {
      @if (auth.canManageReservations()) {
        <app-reservation-form
          [festivalId]="selectedFestivalId()!"
          [reservationToEdit]="editingReservation()"
          (created)="handleCreated()"
          (updated)="handleUpdated()"
          (cancelled)="handleCancelled()"
        />
      } @else {
        <p class="empty">Vous ne pouvez pas créer/modifier de réservations.</p>
      }
    }

    @if (activeTab() === 'jeux') {
      @if (auth.canManagePlacement()) {
        <app-reservation-games
          [festivalId]="selectedFestivalId()!"
          [festival]="currentFestival()"
          [reservation]="gamesReservation()"
        />
      } @else {
        <p class="empty">Vous ne pouvez pas gérer le placement des jeux.</p>
      }
    }

    @if (activeTab() === 'plan') {
      @if (auth.canManagePlacement()) {
        <app-plan-zones [festivalId]="selectedFestivalId()!" />
      } @else {
        <p class="empty">Vous ne pouvez pas gérer les zones du plan.</p>
      }
    }
  } @else {
    <p>Aucun festival disponible.</p>
  }
</section>
