<article class="reservation-card">
  <header>
    <div>
      <p class="eyebrow">Éditeur</p>
      <h3>{{ reservation().editeur }}</h3>
    </div>
    <span class="badge" [attr.data-status]="reservation().statut">
      {{ labelForStatus(reservation().statut) }}
    </span>
  </header>

  <div class="meta">
    <div>
      <p class="label">Tables (espace)</p>
      <p class="value">{{ reservation().tables }}</p>
    </div>
    <div>
      <p class="label">Total</p>
      <p class="value">{{ reservation().prixTotal | currency : 'EUR' : 'symbol' : '1.0-0' }}</p>
    </div>
    <div>
      <p class="label">À payer</p>
      <p class="value strong">{{ reservation().prixFinal | currency : 'EUR' : 'symbol' : '1.0-0' }}</p>
    </div>
  </div>

  @if (reservation().prisesElectriques || reservation().besoinAnimateur || reservation().souhaitGrandesTables || reservation().souhaitTablesStandard || reservation().souhaitTablesMairie) {
    <div class="meta">
      <div>
        <p class="label">Prises</p>
        <p class="value">{{ reservation().prisesElectriques ?? 0 }}</p>
      </div>
      <div>
        <p class="label">Animateur</p>
        <p class="value">{{ reservation().besoinAnimateur ? 'Oui' : 'Non' }}</p>
      </div>
      <div>
        <p class="label">Grandes tables souhaitées</p>
        <p class="value">{{ reservation().souhaitGrandesTables ?? 0 }}</p>
      </div>
      <div>
        <p class="label">Tables standard souhaitées (indicatif)</p>
        <p class="value">{{ reservation().souhaitTablesStandard ?? 0 }}</p>
      </div>
      <div>
        <p class="label">Tables mairie souhaitées (indicatif)</p>
        <p class="value">{{ reservation().souhaitTablesMairie ?? 0 }}</p>
      </div>
    </div>
  }

  @if (reservation().lignes.length) {
    <ul class="zones">
      @for (line of reservation().lignes; track line.zone_nom ?? $index) {
        <li>
          <strong>{{ line.zone_nom ?? 'Zone' }}</strong>
          <span>{{ line.nombre_tables }} table(s)</span>
          @if (line.surface_m2 && line.surface_m2 > 0) {
            <span>{{ line.surface_m2 }} m²</span>
          }
          @if (line.prix_table !== undefined && line.prix_table !== null) {
            <span class="price">
              {{ line.prix_table | currency : 'EUR' : 'symbol' : '1.0-0' }}
            </span>
          }
          @if (line.prix_m2 !== undefined && line.prix_m2 !== null && line.surface_m2 && line.surface_m2 > 0) {
            <span class="price">
              {{ line.prix_m2 | currency : 'EUR' : 'symbol' : '1.0-0' }}/m²
            </span>
          }
        </li>
      }
    </ul>
  }

  @if (lastContact()) {
    <p class="contact">Dernier contact : {{ lastContact() | date }}</p>
  }
  @else {
    <p class="contact">Dernier contact : aucun</p>
  }

  <div class="workflow">
    <label for="statut">Workflow</label>
    <select
      id="statut"
      [value]="reservation().statut"
      (change)="updateStatus($any($event.target).value)"
      [disabled]="saving() || !auth.canManageReservations()"
    >
      @for (status of statuses; track status.value) {
        <option [value]="status.value">{{ status.label }}</option>
      }
    </select>
    @if (saving()) {
      <span class="pill">Mise à jour...</span>
    }
    @if (error()) {
      <span class="error">{{ error() }}</span>
    }
  </div>

  <div class="workflow">
    <label>Facturation</label>
    @if (facture()) {
      <span class="pill" [attr.data-status]="facture()!.statut">
        {{ facture()!.numero }} · {{ facture()!.statut === 'payee' ? 'Payée' : 'Facturée' }}
      </span>
    } @else {
      <span class="pill">Aucune facture</span>
    }
    @if (facture() && facture()!.emise_le) {
      <span class="pill">Émise le {{ facture()!.emise_le | date : 'shortDate' }}</span>
    }
    @if (facture() && facture()!.payee_le) {
      <span class="pill">Payée le {{ facture()!.payee_le | date : 'shortDate' }}</span>
    }
    <div class="actions-row">
      @if (auth.canManageReservations()) {
        @if (canCreateFacture()) {
          <button type="button" class="secondary" (click)="createFacture()" [disabled]="factureLoading()">
            Créer la facture
          </button>
        }
        @if (canMarkPayee()) {
          <button type="button" class="secondary" (click)="markFacturePayee()" [disabled]="factureLoading()">
            Marquer payée
          </button>
        }
      }
      @if (facture()) {
        <button type="button" class="secondary" (click)="toggleFactureDetails()">
          @if (showFactureDetails()) { Masquer la facture } @else { Voir la facture }
        </button>
      }
    </div>
    @if (factureLoading()) {
      <span class="pill">Facturation...</span>
    }
    @if (factureError()) {
      <span class="error">{{ factureError() }}</span>
    }
  </div>

  @if (showFactureDetails() && facture()) {
    <div class="facture-details">
      <div class="facture-summary">
        <div>
          <p class="label">Prix catalogue</p>
          <p class="value">{{ factureBreakdown().totalCatalogue | currency : 'EUR' : 'symbol' : '1.0-0' }}</p>
        </div>
        <div>
          <p class="label">Remise tables</p>
          <p class="value">
            {{ factureBreakdown().remiseTables }}
            @if (factureBreakdown().remiseTables > 0) {
              ({{ factureBreakdown().valeurRemiseTables | currency : 'EUR' : 'symbol' : '1.0-0' }})
            }
          </p>
        </div>
        <div>
          <p class="label">Remise €</p>
          <p class="value">{{ factureBreakdown().remiseArgent | currency : 'EUR' : 'symbol' : '1.0-0' }}</p>
        </div>
        <div>
          <p class="label">Total à payer</p>
          <p class="value strong">{{ factureBreakdown().totalFinal | currency : 'EUR' : 'symbol' : '1.0-0' }}</p>
        </div>
      </div>

      <div class="facture-lines">
        <p class="label">Détail par zone</p>
        <ul class="zones">
          @for (line of factureBreakdown().lignes; track line.zone) {
            <li>
              <strong>{{ line.zone }}</strong>
              <span>{{ line.tables }} table(s)</span>
              @if (line.surface && line.surface > 0) {
                <span>{{ line.surface }} m²</span>
              }
              @if (line.prixTable) {
                <span class="price">{{ line.prixTable | currency : 'EUR' : 'symbol' : '1.0-0' }}</span>
              }
              @if (line.prixM2 && line.surface && line.surface > 0) {
                <span class="price">{{ line.prixM2 | currency : 'EUR' : 'symbol' : '1.0-0' }}/m²</span>
              }
              <span class="price">= {{ line.total | currency : 'EUR' : 'symbol' : '1.0-0' }}</span>
            </li>
          }
        </ul>
      </div>

      <div>
        <p class="label">Numéro</p>
        <p class="value">{{ facture()!.numero }}</p>
      </div>
      <div>
        <p class="label">Montant TTC</p>
        <p class="value">{{ facture()!.montant_ttc | currency : 'EUR' : 'symbol' : '1.0-0' }}</p>
      </div>
      <div>
        <p class="label">Émise le</p>
        <p class="value">{{ facture()!.emise_le | date : 'short' }}</p>
      </div>
      <div>
        <p class="label">Payée le</p>
        <p class="value">
          @if (facture()!.payee_le) {
            {{ facture()!.payee_le | date : 'short' }}
          } @else {
            —
          }
        </p>
      </div>
    </div>
  }

  <div class="workflow">
    <div class="actions-row">
      @if (auth.canManageReservations()) {
        <button type="button" class="secondary" (click)="addContactNow()" [disabled]="saving()">
          Ajouter un contact
        </button>
        <button type="button" class="secondary" (click)="toggleContacts()" [disabled]="loadingContacts()">
          @if (showContacts()) { Masquer l'historique } @else { Voir l'historique }
        </button>
        <button type="button" class="secondary" (click)="requestEdit()">
          Modifier
        </button>
      }
      @if (auth.canManagePlacement()) {
        <button type="button" class="secondary" (click)="requestGames()">
          Jeux & placement
        </button>
      }
    </div>
    @if (loadingContacts()) {
      <span class="pill">Chargement...</span>
    }
  </div>

  @if (showContacts()) {
    <ul class="zones">
      @for (contact of contacts(); track contact.id) {
        <li>
          <strong>{{ contact.date_contact | date : 'short' }}</strong>
          <span>Type: {{ contactTypeLabel(contact.type_contact) }}</span>
          @if (contact.notes) {
            <span>{{ contact.notes }}</span>
          }
        </li>
      }
      @if (contacts().length === 0) {
        <li><span>Aucun contact enregistré.</span></li>
      }
    </ul>
  }
</article>
